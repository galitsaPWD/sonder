rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to validate entry data
    function isValidEntry() {
      let data = request.resource.data;
      return 
        // Required fields
        data.keys().hasAll(['text', 'lat', 'lng', 'timestamp', 'userId', 'color']) &&
        
        // Data type validation
        data.text is string &&
        data.text.size() > 0 && data.text.size() < 2000 &&
        data.lat is number &&
        data.lng is number &&
        data.color is string &&
        // Timestamp must be recent (prevent backdating)
        data.timestamp == request.time; 
    }

    match /entries/{entryId} {
      // 1. ALLOW PUBLIC READ:
      allow read: if true;

      // 2. RESTRICTED CREATE:
      // Allow creation only if the data is valid.
      allow create: if isValidEntry();

      // 3. SECURE UPDATE/DELETE:
      // - UPDATE: Disabled. Entries are immutable (prevents tampering).
      allow update: if false;
      
      // - DELETE: Allowed. 
      // Required for the "Clear All" / "Delete" buttons to work.
      // Since we don't have Auth, we can't restrict this to the "owner".
      // This is a trade-off for usability.
      allow delete: if true; 
    }
  }
}
