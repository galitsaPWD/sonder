<!DOCTYPE html>
<html lang="en" data-page="map">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SONDER · map</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
  <link rel="stylesheet" href="sonder.css?v=88888" />
  <link rel="stylesheet" href="map.css?v=88888" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@500;700&family=Inter:wght@300;400;500&display=swap"
    rel="stylesheet" />
  <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
  <link rel="manifest" href="site.webmanifest">
</head>

<body class="sonder-body sonder-body--map">
  <header class="site-header site-header--overlay">
    <div class="site-header__logo" onclick="window.location.href='index.html'" style="cursor: pointer;">SONDER</div>
    <nav class="site-header__nav">
      <a href="about.html">about</a>
      <a href="archive.html">archive</a>
      <a href="playlist.html">playlist</a>
      <button id="notificationsBtn" class="notifications-btn" title="Notifications">
        <span class="notifications-btn__icon">⩍</span>
        <span class="notifications-badge" id="notificationsBadge" style="display: none;">0</span>
      </button>
      <button class="theme-toggle" id="themeToggle" aria-label="Toggle theme">◐</button>
    </nav>
  </header>

  <main class="map-layout">
    <button class="sidebar-toggle" id="sidebarToggle" aria-label="Toggle sidebar">
      <span class="sidebar-toggle__icon"></span>
    </button>
    <aside class="map-sidebar" id="mapSidebar">
      <div class="sidebar-drag-handle" id="sidebarDragHandle">
        <div class="sidebar-drag-handle__line"></div>
      </div>
      <div class="map-sidebar__section">
        <h2 class="map-sidebar__title" style="font-family: 'Playfair Display', serif; font-weight: 500;">echoes of
          elsewhere</h2>
        <p class="map-sidebar__text">traces left by strangers, right where you stand.</p>
        <p class="map-location-status" id="mapLocationStatus">waiting for location permission…</p>
      </div>
      <div class="map-sidebar__menu">
        <button class="btn btn--ghost" id="mapLocateBtn">refresh location</button>
        <button class="btn btn--ghost" id="mapAddEntryBtn">add entry from here</button>
        <button class="btn btn--ghost" id="mapMyEntriesBtn" onclick="window.location.href='my-entries.html'">my
          entries</button>
        <button class="btn btn--ghost" id="mapAboutBtn" onclick="window.location.href='about.html'">about</button>
      </div>
    </aside>

    <section class="map-canvas-wrapper">
      <div id="map" class="map-canvas" aria-label="world map"></div>
    </section>
  </main>

  <div class="entry-preview" id="entryPreview" hidden></div>

  <div class="modal-overlay" id="mapEntryModal" hidden>
    <div class="modal">
      <button class="modal__close" id="mapEntryModalClose" aria-label="Close">×</button>
      <h2 class="modal__title">leave something small here</h2>
      <form class="entry-form" id="mapEntryForm">
        <textarea name="text" id="mapEntryText" rows="4" placeholder="a memory, a line from a song, a passing feeling"
          required></textarea>
        <label class="entry-form__label">spotify link (optional)
          <input type="url" id="mapEntrySong" name="song" placeholder="optional" />
        </label>
        <label class="entry-form__label">add a photo (optional)
          <input type="file" id="mapEntryImage" name="image" accept="image/jpeg,image/png,image/webp"
            style="display: none;" />
          <div style="display: flex; gap: 0.5rem;">
            <button type="button" class="file-upload-btn" id="fileUploadBtn" style="flex: 1 1 0px; min-width: 0;">
              choose image
            </button>
            <button type="button" class="file-upload-btn" id="cameraBtn" style="flex: 1 1 0px; min-width: 0;">
              take photo
            </button>
          </div>
          <small style="color: var(--color-muted); font-size: 0.75rem; margin-top: 0.5rem; display: block;">max 5mb •
            jpg, png, or webp</small>
        </label>
        <div id="imagePreview" style="display: none; margin-top: 0.5rem;">
          <div style="position: relative; display: inline-block; max-width: 100%;">
            <img id="imagePreviewImg"
              style="max-width: 100%; border-radius: 12px; max-height: 200px; object-fit: cover; display: block;" />
            <button type="button" id="removeImage" class="image-remove-btn" title="Remove image">×</button>
          </div>
        </div>
        <label class="entry-form__label">note color
          <div class="color-picker" id="mapEntryColorPicker">
            <button type="button" class="color-option" data-color="black" style="background: #1a1a1a;"
              title="black"></button>
            <button type="button" class="color-option" data-color="pink"
              style="background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);" title="pink"></button>
            <button type="button" class="color-option" data-color="yellow"
              style="background: linear-gradient(135deg, #feca57 0%, #ffd89b 100%);" title="yellow"></button>
            <button type="button" class="color-option" data-color="blue"
              style="background: linear-gradient(135deg, #74b9ff 0%, #a29bfe 100%);" title="blue"></button>
            <button type="button" class="color-option" data-color="green"
              style="background: linear-gradient(135deg, #55efc4 0%, #81ecec 100%);" title="green"></button>
            <button type="button" class="color-option" data-color="purple"
              style="background: linear-gradient(135deg, #a29bfe 0%, #dfe6e9 100%);" title="purple"></button>
            <button type="button" class="color-option" data-color="orange"
              style="background: linear-gradient(135deg, #fd79a8 0%, #fdcb6e 100%);" title="orange"></button>
          </div>
        </label>

        <!-- Hidden inputs for auto-fetched metadata -->
        <input type="hidden" name="songTitle" id="mapEntrySongTitle" />
        <input type="hidden" name="artist" id="mapEntryArtist" />
        <input type="hidden" name="thumbnail" id="mapEntryThumbnail" />

        <!-- Manual inputs (shown if fetch fails) -->
        <div id="manualSongInputs" style="display: none;">
          <label class="entry-form__label">song title
            <input type="text" name="manualTitle" id="mapEntryManualTitle" placeholder="e.g. Midnight City" />
          </label>
          <label class="entry-form__label">artist
            <input type="text" name="manualArtist" id="mapEntryManualArtist" placeholder="e.g. M83" />
          </label>
        </div>
        <input type="hidden" id="mapEntryLat" name="lat" />
        <input type="hidden" id="mapEntryLng" name="lng" />
        <input type="hidden" id="mapEntryColor" name="color" value="black" />
        <button type="submit" class="btn btn--primary">drop this into the world</button>
      </form>
      <p class="modal__hint">we’ll attach the precise coordinates from your device — nothing manual.</p>
      <p class="modal__error" id="mapEntryError" hidden></p>
      <p class="modal__hint">your entry will be part of the world, forever.</p>
    </div>
  </div>

  <!-- Camera Capture Modal -->
  <div class="modal-overlay" id="cameraModal" hidden>
    <div class="modal modal--camera">
      <button class="modal__close" id="cameraModalClose" aria-label="Close">×</button>
      <div class="camera-viewport">
        <video id="cameraVideo" autoplay playsinline></video>
        <canvas id="cameraCanvas" style="display: none;"></canvas>

        <div class="camera-controls">
          <!-- Spacer for layout balance -->
          <div style="width: 44px;"></div>

          <button type="button" class="camera-capture-btn" id="capturePhotoBtn" aria-label="Take photo">
            <div class="camera-capture-btn__inner"></div>
          </button>

          <button type="button" class="camera-switch-btn" id="switchCameraBtn" title="Switch camera">
            ↳↰
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Welcome Modal for First-Time Users -->
  <div class="modal-overlay" id="welcomeModal" hidden>
    <div class="modal modal--welcome">
      <button class="modal__close" id="welcomeModalClose" aria-label="Close">×</button>
      <h2 class="modal__title">welcome to sonder</h2>
      <div class="modal__content">
        <p style="margin-bottom: 1rem; line-height: 1.6;">
          this is a shared space where people leave traces of their moments—memories, feelings, songs they were
          listening to.
        </p>
        <p style="margin-bottom: 1.5rem; line-height: 1.6;">
          tap refresh location to find where you are, drop a message with add entry, or just wander the map and read
          what everyone else has left behind.
        </p>
        <button class="btn btn--primary" id="welcomeModalGotIt" style="width: 100%;">got it, let's explore</button>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDFJHbgcYloTQY8JR6jAxih6ayNudqfep0",
      authDomain: "sonder031804.firebaseapp.com",
      projectId: "sonder031804",
      storageBucket: "sonder031804.firebasestorage.app",
      messagingSenderId: "996829332000",
      appId: "1:996829332000:web:b466fdedd6b7fa904bf245",
      measurementId: "G-E5PP6QVFK7"
    };

    firebase.initializeApp(firebaseConfig);
    window.db = firebase.firestore();
  </script>
  <script src="sonder.js"></script>
  <script src="share.js"></script>
  <script src="notifications.js"></script>

  <!-- Notifications Modal -->
  <div class="modal-overlay modal-overlay--notifications" id="notificationsModal" hidden>
    <div class="modal modal--notifications">
      <div class="modal__header">
        <h2 class="modal__title">notifications</h2>
        <button id="notificationsModalClose" class="modal__close">×</button>
      </div>
      <div class="modal__body">
        <div id="notificationsList" class="notifications-list">
          <!-- Notifications populated by JS -->
        </div>
        <div id="notificationsEmpty" class="notifications-empty" hidden>
          <div class="notifications-empty__icon">૮(˶ㅠ︿ㅠ)ა</div>
          <p class="notifications-empty__title">no notifications yet</p>
          <p class="notifications-empty__text">you'll be notified when someone posts near your memories.</p>
        </div>
      </div>
    </div>
  </div>
</body>

</html>